name: Install shared software dependencies

inputs:
    os:
        description: "The current operating system"
        required: true
        type: string
        options:
            - amazon-linux
            - macos
            - ubuntu
            - windows
    target:
        description: "Specified target for rust toolchain, ex. x86_64-apple-darwin"
        type: string
        required: false
        default: "x86_64-unknown-linux-gnu"
        options:
            - x86_64-unknown-linux-gnu
            - aarch64-unknown-linux-gnu
            - x86_64-apple-darwin
            - aarch64-apple-darwin
            - aarch64-unknown-linux-musl
            - x86_64-unknown-linux-musl
            - x86_64-pc-windows-msvc
    engine-version:
        description: "Engine version to install"
        required: false
        type: string
    github-token:
        description: "GITHUB_TOKEN, GitHub App installation access token"
        required: true
        type: string

runs:
    using: "composite"
    steps:
        - name: Install software dependencies for macOS
          shell: bash
          if: "${{ inputs.os == 'macos' }}"
          run: |
              brew update
              brew install openssl coreutils

        - name: Install software dependencies for Ubuntu GNU
          shell: bash
          if: "${{ inputs.os == 'ubuntu' && !contains(inputs.target, 'musl')}}"
          run: |
              sudo apt update -y
              sudo apt install -y git gcc pkg-config openssl libssl-dev

        - name: Install software dependencies for MUSL
          shell: bash
          if: "${{ contains(inputs.target, 'musl') }}"
          run: |
              apk update
              wget -O - https://sh.rustup.rs | sh -s -- -y
              source "$HOME/.cargo/env"
              apk add protobuf-dev musl-dev make gcc envsubst openssl libressl-dev py3-pip

        - name: Install software dependencies for Amazon-Linux
          shell: bash
          if: "${{ inputs.os == 'amazon-linux' }}"
          run: |
              yum install -y gcc pkgconfig openssl openssl-devel which curl gettext libasan tar --allowerasing

        - name: Setup Python for Windows
          if: "${{ inputs.os == 'windows' }}"
          uses: actions/setup-python@v5
          with:
              python-version: "3.x"

        # Install Rust toolchain (non-musl only, musl installs via rustup above)
        - name: Install Rust toolchain
          if: "${{ !contains(inputs.target, 'musl') }}"
          uses: dtolnay/rust-toolchain@stable
          with:
              targets: ${{ inputs.target }}

        # Install protoc (non-musl only, musl installs via apk above)
        - name: Install protoc
          if: "${{ !contains(inputs.target, 'musl') }}"
          uses: arduino/setup-protoc@v3
          with:
              version: "25.1"
              repo-token: ${{ inputs.github-token }}

        # Install engine for testing (non-Windows only)
        - name: Install engine
          if: "${{ inputs.engine-version && inputs.os != 'windows' }}"
          shell: bash
          run: |
              ENGINE_VERSION="${{ inputs.engine-version }}"
              echo "Installing Valkey/Redis ${ENGINE_VERSION}..."

              if [[ "${{ inputs.os }}" == "macos" ]]; then
                  brew install valkey || brew install redis
              elif [[ "${{ inputs.os }}" == "amazon-linux" ]]; then
                  yum install -y valkey || yum install -y redis
              elif [[ "${{ contains(inputs.target, 'musl') }}" == "true" ]]; then
                  apk add --no-cache valkey || apk add --no-cache redis
              else
                  sudo apt update
                  sudo apt install -y valkey || sudo apt install -y redis-server || {
                      echo "Installing from source..."
                      curl -fsSL https://github.com/valkey-io/valkey/archive/refs/tags/${ENGINE_VERSION}.tar.gz -o valkey.tar.gz
                      tar xzf valkey.tar.gz
                      cd valkey-${ENGINE_VERSION} && make -j$(nproc) && sudo make install
                  }
              fi

              # Verify
              command -v valkey-server || command -v redis-server || echo "Warning: No server binary found in PATH"
